#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     Ø¨ÙˆØª ØªÙ„ØºØ±Ø§Ù… - Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ          â•‘
â•‘  Ø£Ø³ÙˆØ§Ù‚ Ø³Ø¹ÙˆØ¯ÙŠØ© | Ø£Ù…Ø±ÙŠÙƒÙŠØ© | Ø¹Ù…Ù„Ø§Øª Ø±Ù‚Ù…ÙŠØ©               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
    pip install python-telegram-bot anthropic yfinance pandas numpy requests

Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:
    1. Ø£Ù†Ø´Ø¦ Ø¨ÙˆØª Ù…Ù† @BotFather ÙÙŠ ØªÙ„ØºØ±Ø§Ù… ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ TOKEN
    2. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Claude API Key Ù…Ù† console.anthropic.com
    3. Ø¶Ø¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø£Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
"""

import os
import json
import logging
import asyncio
import re
from datetime import datetime
from typing import Optional
import requests

import anthropic
import yfinance as yf
import pandas as pd
import numpy as np

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    BotCommand,
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)
from telegram.constants import ParseMode

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                      Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "8655325352:AAFYL_q2GF6qk-b4I9tWzV9jl6G1cthF_Gs")
CLAUDE_API_KEY  = os.getenv("CLAUDE_API_KEY",  "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")
NEWS_API_KEY    = os.getenv("NEWS_API_KEY",    "")  # Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ù† newsapi.org

logging.basicConfig(
    format="%(asctime)s | %(levelname)s | %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

claude = anthropic.Anthropic(api_key=CLAUDE_API_KEY)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#         Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
#    ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬: Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù€ SQLite Ø£Ùˆ Redis
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
user_portfolios: dict = {}   # {user_id: [{symbol, qty, buy_price, buy_date}]}
price_alerts: dict   = {}    # {user_id: [{symbol, target, direction}]}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                   Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
HARAM_SECTORS = [
    "Banks", "Financial Services", "Insurance",
    "Beveragesâ€”Brewers", "Beveragesâ€”Wineries",
    "Gambling", "Adult Entertainment", "Tobacco",
    "Defense & Space", "Aerospace & Defense",
]

SHARIAH_OVERRIDE = {
    "2222.SR": ("Ù…ØªÙˆØ§ÙÙ‚",      "âœ… Ø£Ø±Ø§Ù…ÙƒÙˆ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©: Ø´Ø±ÙƒØ© Ù†ÙØ· ÙˆØºØ§Ø² Ù…ØªÙˆØ§ÙÙ‚Ø©."),
    "1120.SR": ("Ù…Ø´Ø¨ÙˆÙ‡",       "âš ï¸ Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ: Ø¨Ù†Ùƒ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù„ÙƒÙ† ÙŠÙˆØ¬Ø¯ Ø¬Ø¯Ù„ ÙÙ‚Ù‡ÙŠ."),
    "1010.SR": ("ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚",  "âŒ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ: Ø¨Ù†Ùƒ Ø±Ø¨ÙˆÙŠ ØªÙ‚Ù„ÙŠØ¯ÙŠ."),
}

def check_shariah(info: dict, symbol: str) -> dict:
    """ØªÙ‚ÙŠÙŠÙ… Ø´Ø±Ø¹ÙŠ Ù…Ø¨Ø³Ø· Ù„Ù„Ø³Ù‡Ù…"""
    sym = symbol.upper()
    if sym in SHARIAH_OVERRIDE:
        verdict, reason = SHARIAH_OVERRIDE[sym]
        return {"verdict": verdict, "reason": reason}

    sector   = info.get("sector", "")   or ""
    industry = info.get("industry", "") or ""
    verdict  = "Ù…ØªÙˆØ§ÙÙ‚"

    for h in HARAM_SECTORS:
        if h.lower() in sector.lower() or h.lower() in industry.lower():
            verdict = "ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚"
            break

    reasons = {
        "Ù…ØªÙˆØ§ÙÙ‚":
            "âœ… Ø§Ù„Ø³Ù‡Ù… ÙŠØ¨Ø¯Ùˆ Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø´Ø±ÙŠØ¹Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø·Ø§Ø¹ Ù†Ø´Ø§Ø·Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.",
        "Ù…Ø´Ø¨ÙˆÙ‡":
            "âš ï¸ Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù†Ø´Ø§Ø· Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø£Ù†Ø´Ø·Ø© Ù…Ø®ØªÙ„Ø·Ø©. ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ù„Ù… Ø´Ø±Ø¹ÙŠ Ù…ØªØ®ØµØµ.",
        "ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚":
            "âŒ Ø§Ù„Ø³Ù‡Ù… ÙÙŠ Ù‚Ø·Ø§Ø¹ Ù…Ø­Ø±Ù… (Ø¨Ù†ÙˆÙƒ Ø±Ø¨ÙˆÙŠØ© / ÙƒØ­ÙˆÙ„ / Ù‚Ù…Ø§Ø± / ØªØ¨Øº / ØªØ³Ù„ÙŠØ­).",
    }
    return {"verdict": verdict, "reason": reasons[verdict]}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                  Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù‡Ù…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def get_stock_data(symbol: str) -> Optional[dict]:
    """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ© ÙˆØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ø³Ù‡Ù… Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©"""
    try:
        ticker = yf.Ticker(symbol)
        info   = ticker.info
        hist   = ticker.history(period="3mo", interval="1d")

        if hist.empty or not info:
            return None

        close = hist["Close"]
        vol   = hist["Volume"]

        # â”€â”€â”€ RSI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        delta = close.diff()
        gain  = delta.clip(lower=0).rolling(14).mean()
        loss  = (-delta.clip(upper=0)).rolling(14).mean()
        rs    = gain / loss
        rsi   = float((100 - 100 / (1 + rs)).iloc[-1])

        # â”€â”€â”€ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ma20 = float(close.rolling(20).mean().iloc[-1])
        ma50 = float(close.rolling(50).mean().iloc[-1]) if len(close) >= 50 else None

        # â”€â”€â”€ Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø¨Ø§Ù†Ø¯Ø² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        std20    = float(close.rolling(20).std().iloc[-1])
        bb_upper = ma20 + 2 * std20
        bb_lower = ma20 - 2 * std20

        # â”€â”€â”€ MACD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ema12        = close.ewm(span=12).mean()
        ema26        = close.ewm(span=26).mean()
        macd         = float((ema12 - ema26).iloc[-1])
        macd_signal  = float((ema12 - ema26).ewm(span=9).mean().iloc[-1])

        # â”€â”€â”€ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© (20 ÙŠÙˆÙ…) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        support    = float(close.rolling(20).min().iloc[-1])
        resistance = float(close.rolling(20).max().iloc[-1])

        current_price = (
            info.get("currentPrice")
            or info.get("regularMarketPrice")
            or float(close.iloc[-1])
        )
        prev_close = info.get("previousClose") or (float(close.iloc[-2]) if len(close) > 1 else current_price)
        change_pct = ((current_price - prev_close) / prev_close) * 100

        return {
            "symbol":        symbol.upper(),
            "name":          info.get("longName") or info.get("shortName", symbol),
            "sector":        info.get("sector",   "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
            "industry":      info.get("industry", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"),
            "current_price": current_price,
            "prev_close":    prev_close,
            "change_pct":    change_pct,
            "market_cap":    info.get("marketCap"),
            "pe_ratio":      info.get("trailingPE"),
            "volume":        int(vol.iloc[-1])  if not vol.empty else 0,
            "avg_volume":    int(vol.mean()),
            "rsi":           rsi,
            "ma20":          ma20,
            "ma50":          ma50,
            "macd":          macd,
            "macd_signal":   macd_signal,
            "bb_upper":      bb_upper,
            "bb_lower":      bb_lower,
            "support":       support,
            "resistance":    resistance,
            "currency":      info.get("currency", "USD"),
            "exchange":      info.get("exchange", ""),
            "info":          info,
        }
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª {symbol}: {e}")
        return None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                  Ø¬Ù„Ø¨ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø³Ù‡Ù…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def get_stock_news(symbol: str, company_name: str) -> list[str]:
    """Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±"""
    headlines = []
    try:
        if NEWS_API_KEY:
            url = (
                f"https://newsapi.org/v2/everything"
                f"?q={company_name}&sortBy=publishedAt&pageSize=5"
                f"&language=en&apiKey={NEWS_API_KEY}"
            )
            r = requests.get(url, timeout=5)
            if r.ok:
                for a in r.json().get("articles", []):
                    headlines.append(a.get("title", ""))
        else:
            news = yf.Ticker(symbol).news or []
            for n in news[:5]:
                headlines.append(n.get("title", ""))
    except Exception as e:
        logger.warning(f"Ø£Ø®Ø¨Ø§Ø±: {e}")
    return headlines


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#            Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ø¨Ø± Claude
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def analyze_with_claude(data: dict, shariah: dict, news: list[str]) -> str:
    news_text = "\n".join(f"- {h}" for h in news) if news else "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ù…ØªØ§Ø­Ø©."

    prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ù…Ø§Ù„ÙŠ Ø¥Ø³Ù„Ø§Ù…ÙŠ. Ù‚Ø¯Ù‘Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ø§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø³Ù‡Ù…:

â”â”â” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù‡Ù… â”â”â”
Ø§Ù„Ø±Ù…Ø²: {data['symbol']} | Ø§Ù„Ø§Ø³Ù…: {data['name']}
Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: {data['current_price']:.2f} {data['currency']}
Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ: {data['change_pct']:+.2f}%
Ø§Ù„Ù‚Ø·Ø§Ø¹: {data['sector']} | Ø§Ù„ØµÙ†Ø§Ø¹Ø©: {data['industry']}
Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©: {f"{data['market_cap']:,}" if data['market_cap'] else 'N/A'}
P/E Ratio: {data['pe_ratio'] or 'N/A'}

â”â”â” Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© â”â”â”
RSI (14): {data['rsi']:.1f}
MA20: {data['ma20']:.2f} | MA50: {f"{data['ma50']:.2f}" if data['ma50'] else 'N/A'}
MACD: {data['macd']:.3f} | Signal: {data['macd_signal']:.3f}
Bollinger Upper: {data['bb_upper']:.2f} | Lower: {data['bb_lower']:.2f}
Ø§Ù„Ø¯Ø¹Ù…: {data['support']:.2f} | Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {data['resistance']:.2f}
Ø§Ù„Ø­Ø¬Ù…: {data['volume']:,} | Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ù…: {data['avg_volume']:,}

â”â”â” Ø§Ù„Ø£Ø®Ø¨Ø§Ø± â”â”â”
{news_text}

â”â”â” Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ â”â”â”
Ø§Ù„Ø­ÙƒÙ…: {shariah['verdict']}
{shariah['reason']}

â”â”â” Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ â”â”â”
Ù‚Ø¯Ù‘Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ù…Ù†Ø¸Ù…Ø§Ù‹ ÙŠØ´Ù…Ù„:
1. **Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹** (3 Ø£Ø³Ø·Ø±)
2. **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ** (RSIØŒ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§ØªØŒ MACDØŒ Ø§Ù„Ø²Ø®Ù… Ø§Ù„Ø¹Ø§Ù…)
3. **ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±** ÙˆØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù‡Ù…
4. **Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ø´Ø±Ø¹ÙŠ** Ù…Ø¹ Ø§Ù„ØªÙØµÙŠÙ„
5. **Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©** (Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ù…Ø«Ù„ Ù„Ù„Ø´Ø±Ø§Ø¡)
6. **Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ** (Take Profit 1 & 2)
7. **ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©** (Stop Loss) Ù…Ø¹ Ø§Ù„ØªØ¨Ø±ÙŠØ±
8. **Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©**: Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ / Ø´Ø±Ø§Ø¡ / Ø§Ù†ØªØ¸Ø§Ø± / ØªØ¬Ù†Ø¨ â€” Ù…Ø¹ Ø§Ù„ØªØ¨Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„

âš ï¸ Ø£Ø¶Ù Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.
"""

    resp = claude.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=1500,
        messages=[{"role": "user", "content": prompt}],
    )
    return resp.content[0].text


def compare_with_claude(d1: dict, d2: dict) -> str:
    prompt = f"""
Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† Ø§Ù„Ø³Ù‡Ù…ÙŠÙ† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ:

Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø£ÙˆÙ„: {d1['symbol']} - {d1['name']}
Ø§Ù„Ø³Ø¹Ø±: {d1['current_price']:.2f} | Ø§Ù„ØªØºÙŠÙŠØ±: {d1['change_pct']:+.2f}%
RSI: {d1['rsi']:.1f} | P/E: {d1['pe_ratio'] or 'N/A'} | Ø§Ù„Ù‚Ø·Ø§Ø¹: {d1['sector']}
Ø§Ù„Ø¯Ø¹Ù…: {d1['support']:.2f} | Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {d1['resistance']:.2f}

Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ: {d2['symbol']} - {d2['name']}
Ø§Ù„Ø³Ø¹Ø±: {d2['current_price']:.2f} | Ø§Ù„ØªØºÙŠÙŠØ±: {d2['change_pct']:+.2f}%
RSI: {d2['rsi']:.1f} | P/E: {d2['pe_ratio'] or 'N/A'} | Ø§Ù„Ù‚Ø·Ø§Ø¹: {d2['sector']}
Ø§Ù„Ø¯Ø¹Ù…: {d2['support']:.2f} | Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {d2['resistance']:.2f}

Ù‚Ø¯Ù‘Ù…:
1. Ù…Ù‚Ø§Ø±Ù†Ø© ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
2. Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ Ø§Ù„Ø­Ø¬Ù…ØŒ Ø§Ù„Ù‚Ø·Ø§Ø¹)
3. Ø§Ù„Ø£ÙØ¶Ù„ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø¢Ù† ÙˆÙ„Ù…Ø§Ø°Ø§ØŸ
4. Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø®ØªØµØ± Ù†ØµÙŠ
"""
    resp = claude.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=1200,
        messages=[{"role": "user", "content": prompt}],
    )
    return resp.content[0].text


def ask_claude_general(question: str) -> str:
    resp = claude.messages.create(
        model="claude-sonnet-4-20250514",
        max_tokens=800,
        system=(
            "Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø§Ù‚ØªØµØ§Ø¯ÙŠ ÙˆÙ…Ø³ØªØ´Ø§Ø± Ù…Ø§Ù„ÙŠ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ© "
            "ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©. ØªØ­Ø¯Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. ÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ§Ù‹ ÙˆÙ…ÙˆØ¬Ø²Ø§Ù‹."
        ),
        messages=[{"role": "user", "content": question}],
    )
    return resp.content[0].text


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#              Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…Ø§Ù„ÙŠ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GLOSSARY = {
    "rsi":         "Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©: ÙŠÙ‚ÙŠØ³ Ø²Ø®Ù… Ø§Ù„Ø³Ø¹Ø±. ÙÙˆÙ‚ 70 = Ø°Ø±ÙˆØ© Ø´Ø±Ø§Ø¡ âš ï¸ØŒ ØªØ­Øª 30 = Ø°Ø±ÙˆØ© Ø¨ÙŠØ¹ ğŸ¯.",
    "macd":        "MACD: ÙŠÙ‚ÙŠØ³ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ù…ØªÙˆØ³Ø·ÙŠÙ† Ø£Ø³ÙŠÙŠÙ†. Ù‚Ø·Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ = Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù…Ø­ØªÙ…Ù„Ø©.",
    "pe":          "Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø±Ø¨Ø­ÙŠØ© P/E: Ø§Ù„Ø³Ø¹Ø± Ã· Ø§Ù„Ø±Ø¨Ø­ÙŠØ©. ÙŠÙˆØ¶Ø­ ÙƒÙ… ÙŠØ¯ÙØ¹ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø± Ù…Ù‚Ø§Ø¨Ù„ ÙƒÙ„ ÙˆØ­Ø¯Ø© Ø±Ø¨Ø­.",
    "support":     "Ø§Ù„Ø¯Ø¹Ù…: Ù…Ø³ØªÙˆÙ‰ Ø³Ø¹Ø±ÙŠ ÙŠØ±ØªØ¯ Ù…Ù†Ù‡ Ø§Ù„Ø³Ù‡Ù… Ù„Ù„Ø£Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ®ÙŠØ§Ù‹. ÙƒØ³Ø±Ù‡ = Ø¥Ø´Ø§Ø±Ø© Ù‡Ø¨ÙˆØ·.",
    "resistance":  "Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: Ù…Ø³ØªÙˆÙ‰ ÙŠØµØ¹Ø¨ ØªØ¬Ø§ÙˆØ²Ù‡. Ø§Ø®ØªØ±Ø§Ù‚Ù‡ = Ø¥Ø´Ø§Ø±Ø© ØµØ¹ÙˆØ¯ Ù‚ÙˆÙŠØ©.",
    "ma":          "Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ: Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù„Ù‰ ÙØªØ±Ø©. ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù….",
    "bollinger":   "Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø¨Ø§Ù†Ø¯Ø²: Ù‚Ù†ÙˆØ§Øª Ø­ÙˆÙ„ MA20. Ù„Ù…Ø³ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù‚Ø¯ ÙŠØ¹Ù†ÙŠ ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¡.",
    "ipo":         "Ø§Ù„Ø·Ø±Ø­ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ÙŠ: Ø£ÙˆÙ„ Ø¥Ø¯Ø±Ø§Ø¬ Ù„Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¨ÙˆØ±ØµØ© Ù„Ø¬Ù…Ø¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ„.",
    "etf":         "ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø¤Ø´Ø±: ÙŠØªØªØ¨Ø¹ Ù…Ø¤Ø´Ø±Ø§Ù‹ ÙƒÙ€ S&P 500 ÙˆÙŠÙØªØ¯Ø§ÙˆÙ„ ÙƒØ³Ù‡Ù… Ø¹Ø§Ø¯ÙŠ.",
    "stop loss":   "ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: Ø£Ù…Ø± Ø¨ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø³Ø¹Ø± Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø­Ø¯ Ù…Ù† Ø§Ù„Ø®Ø³Ø§Ø¦Ø±.",
    "take profit": "Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: Ø£Ù…Ø± Ø¨ÙŠØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­.",
    "volume":      "Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„: Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©. Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¹Ø§Ù„ÙŠ ÙŠØ¤ÙƒØ¯ Ù‚ÙˆØ© Ø§Ù„Ø­Ø±ÙƒØ©.",
    "market cap":  "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©: Ø§Ù„Ø³Ø¹Ø± Ã— Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…. ØªØ¹Ø¨Ù‘Ø± Ø¹Ù† Ø­Ø¬Ù… Ø§Ù„Ø´Ø±ÙƒØ©.",
    "eps":         "Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø³Ù‡Ù… EPS: ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…. Ù…Ø¤Ø´Ø± ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø´Ø±ÙƒØ©.",
    "yield":       "Ø§Ù„Ø¹Ø§Ø¦Ø¯: Ù†Ø³Ø¨Ø© ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¥Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù…. Ù…Ù‡Ù… Ù„Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ† Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¹Ù† Ø¯Ø®Ù„.",
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                   Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [
            InlineKeyboardButton("ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø³Ù‡Ù…",    callback_data="menu_analyze"),
            InlineKeyboardButton("ğŸ” Ù…Ù‚Ø§Ø±Ù†Ø© Ø³Ù‡Ù…ÙŠÙ†", callback_data="menu_compare"),
        ],
        [
            InlineKeyboardButton("ğŸ’¼ Ù…Ø­ÙØ¸ØªÙŠ",        callback_data="menu_portfolio"),
            InlineKeyboardButton("ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø³Ø¹Ø±", callback_data="menu_alerts"),
        ],
        [
            InlineKeyboardButton("ğŸ“š Ù‚Ø§Ù…ÙˆØ³ Ù…Ø§Ù„ÙŠ",    callback_data="menu_glossary"),
            InlineKeyboardButton("â“ Ø§Ø³Ø£Ù„ Ø§Ù„Ø®Ø¨ÙŠØ±",   callback_data="menu_ask"),
        ],
    ]
    await update.message.reply_text(
        "ğŸŒŸ *Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ* ğŸŒŸ\n\n"
        "Ù…ØªØ®ØµØµ ÙÙŠ:\n"
        "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© (ØªØ¯Ø§ÙˆÙ„)\n"
        "ğŸ‡ºğŸ‡¸ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ© (NYSE/NASDAQ)\n"
        "â‚¿ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©\n"
        "â˜ªï¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø­Ù„Ø§Ù„\n\n"
        "ğŸ“Œ Ø£Ø±Ø³Ù„ Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ\n"
        "Ù…Ø«Ø§Ù„: `AAPL` Ø£Ùˆ `2222.SR` Ø£Ùˆ `BTC-USD`",
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=InlineKeyboardMarkup(keyboard),
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ“– *Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…*\n\n"
        "`AAPL` Ø£Ùˆ `2222.SR` â€” ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ\n"
        "`/analyze AAPL` â€” ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ\n"
        "`/compare AAPL MSFT` â€” Ù…Ù‚Ø§Ø±Ù†Ø© Ø³Ù‡Ù…ÙŠÙ†\n"
        "`/portfolio` â€” Ø¹Ø±Ø¶ Ù…Ø­ÙØ¸ØªÙƒ\n"
        "`/add_stock AAPL 10 180` â€” Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù… (Ø±Ù…Ø²ØŒ ÙƒÙ…ÙŠØ©ØŒ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡)\n"
        "`/alert AAPL 200 up` â€” ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø¹Ø±\n"
        "`/glossary rsi` â€” Ø´Ø±Ø­ Ù…ØµØ·Ù„Ø­ Ù…Ø§Ù„ÙŠ\n"
        "`/ask Ø³Ø¤Ø§Ù„Ùƒ` â€” Ø§Ø³Ø£Ù„ Ø§Ù„Ø®Ø¨ÙŠØ± Ø£ÙŠ Ø³Ø¤Ø§Ù„\n",
        parse_mode=ParseMode.MARKDOWN,
    )


async def analyze_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text(
            "ğŸ“Œ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: `/analyze Ø±Ù…Ø²Ø§Ù„Ø³Ù‡Ù…`\nÙ…Ø«Ø§Ù„: `/analyze AAPL`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    await _do_analysis(update, context, context.args[0].upper())


async def _do_analysis(update: Update, context: ContextTypes.DEFAULT_TYPE, symbol: str):
    msg = await update.message.reply_text(f"â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª {symbol}...")

    data = get_stock_data(symbol)
    if not data:
        await msg.edit_text(
            f"âŒ Ù„Ù… Ø£Ø¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø±Ù…Ø² *{symbol}*\n"
            "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù…Ø² ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.\n"
            "Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€ `.SR` Ù…Ø«Ù„ `2222.SR`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return

    shariah = check_shariah(data["info"], symbol)
    news    = get_stock_news(symbol, data["name"])

    await msg.edit_text(f"ğŸ§  Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù€ *{symbol}*...", parse_mode=ParseMode.MARKDOWN)
    analysis = analyze_with_claude(data, shariah, news)

    arrow  = "ğŸŸ¢" if data["change_pct"] >= 0 else "ğŸ”´"
    header = (
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"{arrow} *{data['name']}* `{data['symbol']}`\n"
        f"ğŸ’µ *{data['current_price']:.2f} {data['currency']}*  {data['change_pct']:+.2f}%\n"
        f"ğŸ“Š RSI: {data['rsi']:.1f}  |  {data['sector']}\n"
        f"ğŸ•Œ Ø§Ù„Ø´Ø±ÙŠØ¹Ø©: *{shariah['verdict']}*\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
    )

    full = header + analysis
    for i in range(0, len(full), 4000):
        chunk = full[i : i + 4000]
        if i == 0:
            await msg.edit_text(chunk, parse_mode=ParseMode.MARKDOWN)
        else:
            await update.message.reply_text(chunk, parse_mode=ParseMode.MARKDOWN)


async def compare_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) < 2:
        await update.message.reply_text(
            "ğŸ“Œ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: `/compare Ø±Ù…Ø²1 Ø±Ù…Ø²2`\nÙ…Ø«Ø§Ù„: `/compare AAPL MSFT`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    s1, s2 = context.args[0].upper(), context.args[1].upper()
    msg = await update.message.reply_text(f"â³ Ø¬Ø§Ø±ÙŠ Ù…Ù‚Ø§Ø±Ù†Ø© {s1} Ùˆ {s2}...")
    d1  = get_stock_data(s1)
    d2  = get_stock_data(s2)
    if not d1 or not d2:
        await msg.edit_text("âŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø­Ø¯ Ø§Ù„Ø³Ù‡Ù…ÙŠÙ†.")
        return
    result = compare_with_claude(d1, d2)
    await msg.edit_text(
        f"ğŸ” *Ù…Ù‚Ø§Ø±Ù†Ø© {s1} vs {s2}*\n\n{result}",
        parse_mode=ParseMode.MARKDOWN,
    )


async def portfolio_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid  = update.effective_user.id
    port = user_portfolios.get(uid, [])
    if not port:
        await update.message.reply_text(
            "ğŸ’¼ Ù…Ø­ÙØ¸ØªÙƒ ÙØ§Ø±ØºØ©!\n"
            "Ø£Ø¶Ù Ø³Ù‡Ù…Ø§Ù‹: `/add_stock AAPL 10 180`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return

    lines = ["ğŸ’¼ *Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"]
    total_cost = total_value = 0.0

    for item in port:
        d = get_stock_data(item["symbol"])
        if not d:
            continue
        cost  = item["qty"] * item["buy_price"]
        value = item["qty"] * d["current_price"]
        pnl   = value - cost
        pct   = (pnl / cost) * 100
        lines.append(
            f"\n{'ğŸ“ˆ' if pnl >= 0 else 'ğŸ“‰'} *{item['symbol']}* Ã—{item['qty']}\n"
            f"   Ø´Ø±Ø§Ø¡: {item['buy_price']:.2f}  â†’  Ø­Ø§Ù„ÙŠ: {d['current_price']:.2f}\n"
            f"   Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø©: *{pnl:+.2f}* ({pct:+.1f}%)"
        )
        total_cost  += cost
        total_value += value

    total_pnl = total_value - total_cost
    total_pct = (total_pnl / total_cost * 100) if total_cost else 0
    lines += [
        "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: {total_cost:.2f}",
        f"ğŸ’µ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {total_value:.2f}",
        f"{'âœ…' if total_pnl >= 0 else 'âŒ'} Ø¥Ø¬Ù…Ø§Ù„ÙŠ: *{total_pnl:+.2f}* ({total_pct:+.1f}%)",
    ]
    await update.message.reply_text("\n".join(lines), parse_mode=ParseMode.MARKDOWN)


async def add_stock_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) < 3:
        await update.message.reply_text(
            "ğŸ“Œ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: `/add_stock Ø±Ù…Ø² Ø§Ù„ÙƒÙ…ÙŠØ© Ø³Ø¹Ø±Ø§Ù„Ø´Ø±Ø§Ø¡`\n"
            "Ù…Ø«Ø§Ù„: `/add_stock AAPL 10 180.5`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    try:
        symbol    = context.args[0].upper()
        qty       = float(context.args[1])
        buy_price = float(context.args[2])
        uid       = update.effective_user.id
        user_portfolios.setdefault(uid, []).append({
            "symbol":    symbol,
            "qty":       qty,
            "buy_price": buy_price,
            "buy_date":  datetime.now().strftime("%Y-%m-%d"),
        })
        await update.message.reply_text(
            f"âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© *{qty}* Ø³Ù‡Ù… Ù…Ù† *{symbol}* Ø¨Ø³Ø¹Ø± *{buy_price}* Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ.",
            parse_mode=ParseMode.MARKDOWN,
        )
    except ValueError:
        await update.message.reply_text("âŒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.")


async def alert_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) < 3:
        await update.message.reply_text(
            "ğŸ“Œ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: `/alert Ø±Ù…Ø² Ø§Ù„Ø³Ø¹Ø± up/down`\n"
            "Ù…Ø«Ø§Ù„: `/alert AAPL 200 up`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    try:
        symbol    = context.args[0].upper()
        target    = float(context.args[1])
        direction = context.args[2].lower()
        uid       = update.effective_user.id
        price_alerts.setdefault(uid, []).append(
            {"symbol": symbol, "target": target, "direction": direction}
        )
        dir_ar = "ÙŠØµØ¹Ø¯ Ø¥Ù„Ù‰" if direction == "up" else "ÙŠÙ†Ø²Ù„ Ø¥Ù„Ù‰"
        await update.message.reply_text(
            f"ğŸ”” ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡: Ø³Ø£Ø®Ø¨Ø±Ùƒ Ø­ÙŠÙ† {dir_ar} *{symbol}* â†’ *{target}*",
            parse_mode=ParseMode.MARKDOWN,
        )
    except ValueError:
        await update.message.reply_text("âŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.")


async def glossary_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        terms = " | ".join(GLOSSARY.keys())
        await update.message.reply_text(
            f"ğŸ“š *Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…Ø§Ù„ÙŠ*\n\n{terms}\n\nÙ…Ø«Ø§Ù„: `/glossary rsi`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    term = " ".join(context.args).lower()
    if term in GLOSSARY:
        await update.message.reply_text(
            f"ğŸ“– *{term.upper()}*\n\n{GLOSSARY[term]}",
            parse_mode=ParseMode.MARKDOWN,
        )
    else:
        answer = ask_claude_general(f"Ø§Ø´Ø±Ø­ Ù…ØµØ·Ù„Ø­ '{term}' Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø· ÙÙŠ ÙÙ‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.")
        await update.message.reply_text(
            f"ğŸ“– *{term}*\n\n{answer}",
            parse_mode=ParseMode.MARKDOWN,
        )


async def ask_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text(
            "ğŸ“Œ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: `/ask Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§`",
            parse_mode=ParseMode.MARKDOWN,
        )
        return
    msg    = await update.message.reply_text("ğŸ¤” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø¬Ø§Ø¨Ø©...")
    answer = ask_claude_general(" ".join(context.args))
    await msg.edit_text(f"ğŸ’¬ *Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:*\n\n{answer}", parse_mode=ParseMode.MARKDOWN)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© â€” Ø±Ù…Ø² Ø³Ù‡Ù… Ø£Ùˆ Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù…"""
    text = update.message.text.strip()
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù…Ø² Ø³Ù‡Ù…
    if re.match(r'^[A-Za-z0-9.\-]{1,12}$', text) and len(text.strip()) >= 1:
        await _do_analysis(update, context, text.upper())
    else:
        msg    = await update.message.reply_text("ğŸ¤” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...")
        answer = ask_claude_general(text)
        await msg.edit_text(f"ğŸ’¬ {answer}", parse_mode=ParseMode.MARKDOWN)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data  = query.data

    responses = {
        "menu_analyze":   "ğŸ“Š Ø£Ø±Ø³Ù„ Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø©\nÙ…Ø«Ø§Ù„: `AAPL` Ø£Ùˆ `2222.SR` Ø£Ùˆ `BTC-USD`",
        "menu_compare":   "ğŸ” Ø£Ø±Ø³Ù„: `/compare Ø±Ù…Ø²1 Ø±Ù…Ø²2`\nÙ…Ø«Ø§Ù„: `/compare AAPL TSLA`",
        "menu_alerts":    "ğŸ”” Ø£Ø±Ø³Ù„: `/alert Ø±Ù…Ø² Ø§Ù„Ø³Ø¹Ø± up/down`\nÙ…Ø«Ø§Ù„: `/alert AAPL 200 up`",
        "menu_ask":       "â“ Ø£Ø±Ø³Ù„: `/ask Ø³Ø¤Ø§Ù„Ùƒ` Ø£Ùˆ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.",
        "menu_glossary":  "ğŸ“š Ø£Ø±Ø³Ù„: `/glossary rsi` Ø£Ùˆ Ø£ÙŠ Ù…ØµØ·Ù„Ø­ Ù…Ø§Ù„ÙŠ.",
    }

    if data == "menu_portfolio":
        await portfolio_command(update, context)
    elif data in responses:
        await query.message.reply_text(responses[data], parse_mode=ParseMode.MARKDOWN)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#           ÙˆØ¸ÙŠÙØ© ØªØ­Ù‚Ù‚ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async def check_alerts_job(context: ContextTypes.DEFAULT_TYPE):
    for uid, alerts in list(price_alerts.items()):
        triggered, remaining = [], []
        for a in alerts:
            d = get_stock_data(a["symbol"])
            if not d:
                remaining.append(a)
                continue
            price = d["current_price"]
            hit = (a["direction"] == "up"   and price >= a["target"]) or \
                  (a["direction"] == "down"  and price <= a["target"])
            (triggered if hit else remaining).append(a if not hit else (a, price))
        price_alerts[uid] = remaining
        for a, price in triggered:
            try:
                await context.bot.send_message(
                    chat_id=uid,
                    text=(
                        f"ğŸš¨ *ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø¹Ø±!*\n\n"
                        f"ÙˆØµÙ„ *{a['symbol']}* Ø¥Ù„Ù‰ *{price:.2f}*\n"
                        f"Ø§Ù„Ù‡Ø¯Ù ÙƒØ§Ù†: {a['target']} ({a['direction']})"
                    ),
                    parse_mode=ParseMode.MARKDOWN,
                )
            except Exception:
                pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                     Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def main():
    app = Application.builder().token(TELEGRAM_TOKEN).build()

    app.add_handler(CommandHandler("start",      start))
    app.add_handler(CommandHandler("help",       help_command))
    app.add_handler(CommandHandler("analyze",    analyze_command))
    app.add_handler(CommandHandler("compare",    compare_command))
    app.add_handler(CommandHandler("portfolio",  portfolio_command))
    app.add_handler(CommandHandler("add_stock",  add_stock_command))
    app.add_handler(CommandHandler("alert",      alert_command))
    app.add_handler(CommandHandler("glossary",   glossary_command))
    app.add_handler(CommandHandler("ask",        ask_command))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
    app.job_queue.run_repeating(check_alerts_job, interval=900, first=30)

    async def post_init(application: Application):
        await application.bot.set_my_commands([
            BotCommand("start",     "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"),
            BotCommand("analyze",   "ØªØ­Ù„ÙŠÙ„ Ø³Ù‡Ù…"),
            BotCommand("compare",   "Ù…Ù‚Ø§Ø±Ù†Ø© Ø³Ù‡Ù…ÙŠÙ†"),
            BotCommand("portfolio", "Ù…Ø­ÙØ¸ØªÙŠ"),
            BotCommand("add_stock", "Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù… Ù„Ù„Ù…Ø­ÙØ¸Ø©"),
            BotCommand("alert",     "Ø¶Ø¨Ø· ØªÙ†Ø¨ÙŠÙ‡ Ø³Ø¹Ø±"),
            BotCommand("glossary",  "Ù‚Ø§Ù…ÙˆØ³ Ù…Ø§Ù„ÙŠ"),
            BotCommand("ask",       "Ø§Ø³Ø£Ù„ Ø§Ù„Ø®Ø¨ÙŠØ±"),
            BotCommand("help",      "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"),
        ])

    app.post_init = post_init
    logger.info("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
    app.run_polling(drop_pending_updates=True)


if __name__ == "__main__":
    main()
